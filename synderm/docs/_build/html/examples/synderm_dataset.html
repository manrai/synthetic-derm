

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Using the synderm dataset &mdash; synderm 0.1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=a58bc63e"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            synderm
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="train_with_synthetic_images.html">Vignette: Augmenting an image classifier with synthetic images from your data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">synderm</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Using the synderm dataset</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/synderm_dataset.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Using-the-synderm-dataset">
<h1>Using the synderm dataset<a class="headerlink" href="#Using-the-synderm-dataset" title="Link to this heading">ÔÉÅ</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">webdataset</span> <span class="k">as</span> <span class="nn">wds</span>
<span class="kn">from</span> <span class="nn">huggingface_hub</span> <span class="kn">import</span> <span class="n">get_token</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">import</span> <span class="nn">json</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cache_dir</span> <span class="o">=</span> <span class="s2">&quot;/n/scratch/users/t/thb286/hf_cache&quot;</span>
<span class="n">hf_token</span> <span class="o">=</span> <span class="n">get_token</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CLASS_NAMES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;allergic-contact-dermatitis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;basal-cell-carcinoma&quot;</span><span class="p">,</span>
    <span class="s2">&quot;folliculitis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lichen-planus&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">hf_token</span> <span class="o">=</span> <span class="n">get_token</span><span class="p">()</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-{&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CLASS_NAMES</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}-finetune-inpaint-inpaint-00000.tar&quot;</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">wds</span><span class="o">.</span><span class="n">WebDataset</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">class_counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">CLASS_NAMES</span><span class="p">}</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">class_counts</span><span class="p">)</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">])</span>

    <span class="n">class_name</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
    <span class="n">class_counts</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Number of images per class:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">class_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-all-finetune-inpaint-inpaint-00000.tar&quot;</span>

<span class="c1"># Create dataset from the shard URL</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">wds</span><span class="o">.</span><span class="n">WebDataset</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">wds</span><span class="o">.</span><span class="n">warn_and_continue</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>  <span class="c1"># Decode the data from the tar file</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-allergic-contact-dermatitis-finetune-inpaint-inpaint-{{00000..00004}}.tar&quot;</span>
<span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pipe:curl -s -L </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> -H &#39;Authorization:Bearer </span><span class="si">{</span><span class="n">hf_token</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">wds</span><span class="o">.</span><span class="n">WebDataset</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<span class="c1">#dataloader = DataLoader(dataset, batch_size=64, num_workers=4)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The dataloader pipeline is a fairly typical `IterableDataset` pipeline</span>
<span class="c1"># for PyTorch</span>


<span class="k">def</span> <span class="nf">make_dataloader_train</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a DataLoader for training on the ImageNet dataset using WebDataset.&quot;&quot;&quot;</span>

    <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">RandomResizedCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">transform</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;jpg&quot;</span><span class="p">]),</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;cls&quot;</span><span class="p">]</span>

    <span class="c1"># This is the basic WebDataset definition: it starts with a URL and add shuffling,</span>
    <span class="c1"># decoding, and augmentation. Note `resampled=True`; this is essential for</span>
    <span class="c1"># distributed training to work correctly.</span>
    <span class="n">trainset</span> <span class="o">=</span> <span class="n">wds</span><span class="o">.</span><span class="n">WebDataset</span><span class="p">(</span><span class="n">trainset_url</span><span class="p">,</span> <span class="n">resampled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">nodesplitter</span><span class="o">=</span><span class="n">wds</span><span class="o">.</span><span class="n">split_by_node</span><span class="p">)</span>
    <span class="n">trainset</span> <span class="o">=</span> <span class="n">trainset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;pil&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">make_sample</span><span class="p">)</span>

    <span class="c1"># For IterableDataset objects, the batching needs to happen in the dataset.</span>
    <span class="n">trainset</span> <span class="o">=</span> <span class="n">trainset</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">trainloader</span> <span class="o">=</span> <span class="n">wds</span><span class="o">.</span><span class="n">WebLoader</span><span class="p">(</span><span class="n">trainset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># We unbatch, shuffle, and rebatch to mix samples from different workers.</span>
    <span class="n">trainloader</span> <span class="o">=</span> <span class="n">trainloader</span><span class="o">.</span><span class="n">unbatched</span><span class="p">()</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>

    <span class="c1"># A resampled dataset is infinite size, but we can recreate a fixed epoch length.</span>
    <span class="n">trainloader</span> <span class="o">=</span> <span class="n">trainloader</span><span class="o">.</span><span class="n">with_epoch</span><span class="p">(</span><span class="mi">1282</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">//</span> <span class="mi">64</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">trainloader</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CLASS_NAMES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;allergic-contact-dermatitis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;basal-cell-carcinoma&quot;</span><span class="p">,</span>
    <span class="s2">&quot;folliculitis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lichen-planus&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">hf_token</span> <span class="o">=</span> <span class="n">get_token</span><span class="p">()</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-{&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CLASS_NAMES</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}-finetune-inpaint-inpaint-00000.tar&quot;</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">wds</span><span class="o">.</span><span class="n">WebDataset</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="n">class_counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">CLASS_NAMES</span><span class="p">}</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">class_counts</span><span class="p">)</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">])</span>

    <span class="n">class_name</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
    <span class="n">class_counts</span><span class="p">[</span><span class="n">class_name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Number of images per class:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">class_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;allergic-contact-dermatitis&#39;: 0, &#39;basal-cell-carcinoma&#39;: 0, &#39;folliculitis&#39;: 0, &#39;lichen-planus&#39;: 0}
{&#39;allergic-contact-dermatitis&#39;: 1000, &#39;basal-cell-carcinoma&#39;: 0, &#39;folliculitis&#39;: 0, &#39;lichen-planus&#39;: 0}
{&#39;allergic-contact-dermatitis&#39;: 2000, &#39;basal-cell-carcinoma&#39;: 0, &#39;folliculitis&#39;: 0, &#39;lichen-planus&#39;: 0}
{&#39;allergic-contact-dermatitis&#39;: 3000, &#39;basal-cell-carcinoma&#39;: 0, &#39;folliculitis&#39;: 0, &#39;lichen-planus&#39;: 0}
{&#39;allergic-contact-dermatitis&#39;: 3580, &#39;basal-cell-carcinoma&#39;: 420, &#39;folliculitis&#39;: 0, &#39;lichen-planus&#39;: 0}
{&#39;allergic-contact-dermatitis&#39;: 3580, &#39;basal-cell-carcinoma&#39;: 1420, &#39;folliculitis&#39;: 0, &#39;lichen-planus&#39;: 0}
{&#39;allergic-contact-dermatitis&#39;: 3580, &#39;basal-cell-carcinoma&#39;: 2420, &#39;folliculitis&#39;: 0, &#39;lichen-planus&#39;: 0}
{&#39;allergic-contact-dermatitis&#39;: 3580, &#39;basal-cell-carcinoma&#39;: 3420, &#39;folliculitis&#39;: 0, &#39;lichen-planus&#39;: 0}
{&#39;allergic-contact-dermatitis&#39;: 3580, &#39;basal-cell-carcinoma&#39;: 4060, &#39;folliculitis&#39;: 360, &#39;lichen-planus&#39;: 0}
{&#39;allergic-contact-dermatitis&#39;: 3580, &#39;basal-cell-carcinoma&#39;: 4060, &#39;folliculitis&#39;: 1360, &#39;lichen-planus&#39;: 0}
{&#39;allergic-contact-dermatitis&#39;: 3580, &#39;basal-cell-carcinoma&#39;: 4060, &#39;folliculitis&#39;: 1910, &#39;lichen-planus&#39;: 450}
{&#39;allergic-contact-dermatitis&#39;: 3580, &#39;basal-cell-carcinoma&#39;: 4060, &#39;folliculitis&#39;: 1910, &#39;lichen-planus&#39;: 1450}
{&#39;allergic-contact-dermatitis&#39;: 3580, &#39;basal-cell-carcinoma&#39;: 4060, &#39;folliculitis&#39;: 1910, &#39;lichen-planus&#39;: 2450}
{&#39;allergic-contact-dermatitis&#39;: 3580, &#39;basal-cell-carcinoma&#39;: 4060, &#39;folliculitis&#39;: 1910, &#39;lichen-planus&#39;: 3450}

Number of images per class:
allergic-contact-dermatitis: 3580
basal-cell-carcinoma: 4060
folliculitis: 1910
lichen-planus: 4120
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
pipe:curl -s -L https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-{allergic-contact-dermatitis,basal-cell-carcinoma,folliculitis,lichen-planus,lupus-erythematosus,neutrophilic-dermatoses,photodermatoses,psoriasis,sarcoidosis,squamous-cell-carcinoma}-finetune-inpaint-inpaint-00000.tar -H &#39;Authorization:Bearer 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&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Preview first item from dataset</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Only show first image</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Keys in item:&quot;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># Convert bytes to numpy array and display</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;png&#39;</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">break</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Keys in item: dict_keys([&#39;__key__&#39;, &#39;__url__&#39;, &#39;json&#39;, &#39;__local_path__&#39;, &#39;png&#39;])
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_synderm_dataset_12_1.png" src="../_images/examples_synderm_dataset_12_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CLASS_NAMES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;allergic-contact-dermatitis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;basal-cell-carcinoma&quot;</span><span class="p">,</span>
    <span class="s2">&quot;folliculitis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lichen-planus&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lupus-erythematosus&quot;</span><span class="p">,</span>
    <span class="s2">&quot;neutrophilic-dermatoses&quot;</span><span class="p">,</span>
    <span class="s2">&quot;photodermatoses&quot;</span><span class="p">,</span>
    <span class="s2">&quot;psoriasis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sarcoidosis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;squamous-cell-carcinoma&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1">#</span>
<span class="n">bucket</span> <span class="o">=</span> <span class="s2">&quot;https://storage.googleapis.com/webdataset/testdata/&quot;</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;publaynet-train-{000000..000009}.tar&quot;</span>

<span class="n">url</span> <span class="o">=</span> <span class="n">bucket</span> <span class="o">+</span> <span class="n">dataset</span>
<span class="o">!</span>curl<span class="w"> </span>-s<span class="w"> </span><span class="o">{</span>url<span class="o">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tar<span class="w"> </span>tf<span class="w"> </span>-<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>10q

<span class="c1"># Load a single shard for each label from the fine-tuned text-to-image method</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">CLASS_NAMES</span><span class="p">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">-finetune-inpaint-inpaint-00000.tar&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="c1"># Create dataset from the shard URL and decode it</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">wds</span><span class="o">.</span><span class="n">WebDataset</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">wds</span><span class="o">.</span><span class="n">warn_and_continue</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

    <span class="c1"># Preview first item from dataset</span>
    <span class="c1"># for i, item in enumerate(dataset):</span>
    <span class="c1">#     if i == 3:</span>
    <span class="c1">#         break</span>

    <span class="c1">#     print(item[&#39;json&#39;])</span>

    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-allergic-contact-dermatitis-finetune-inpaint-inpaint-00000.tar
https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-basal-cell-carcinoma-finetune-inpaint-inpaint-00000.tar
https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-folliculitis-finetune-inpaint-inpaint-00000.tar
https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-lichen-planus-finetune-inpaint-inpaint-00000.tar
https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-lupus-erythematosus-finetune-inpaint-inpaint-00000.tar
https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-neutrophilic-dermatoses-finetune-inpaint-inpaint-00000.tar
https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-photodermatoses-finetune-inpaint-inpaint-00000.tar
https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-psoriasis-finetune-inpaint-inpaint-00000.tar
https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-sarcoidosis-finetune-inpaint-inpaint-00000.tar
https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-squamous-cell-carcinoma-finetune-inpaint-inpaint-00000.tar
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;webdataset.compat.WebDataset at 0x7f210967a0e0&gt;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hf_token</span> <span class="o">=</span> <span class="n">get_token</span><span class="p">()</span>
<span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://huggingface.co/datasets/tbuckley/synthetic-derm-1M/resolve/main/data/shard-</span><span class="se">{{</span><span class="s2">0..11</span><span class="se">}}</span><span class="s2">-finetune-inpaint-inpaint-00000.tar&quot;</span>
<span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pipe:curl -s -L </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> -H &#39;Authorization:Bearer </span><span class="si">{</span><span class="n">hf_token</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">wds</span><span class="o">.</span><span class="n">WebDataset</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/thb286/synthetic-derm/.venv/lib/python3.10/site-packages/webdataset/compat.py:136: UserWarning: WebDataset(shardshuffle=...) is None; set explicitly to False or a number
  warnings.warn(&#34;WebDataset(shardshuffle=...) is None; set explicitly to False or a number&#34;)
/home/thb286/synthetic-derm/.venv/lib/python3.10/site-packages/torch/utils/data/dataloader.py:617: UserWarning: This DataLoader will create 4 worker processes in total. Our suggested max number of worker in current system is 1, which is smaller than what this DataLoader is going to create. Please be aware that excessive worker creation might get DataLoader running slow or even freeze, lower the worker number to avoid potential slowness/freeze if necessary.
  warnings.warn(
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1"># Preview first item from dataset</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">])</span>
    <span class="k">break</span>

<span class="c1">#dataloader = DataLoader(dataset)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The keys are  dict_keys([&#39;__key__&#39;, &#39;__url__&#39;, &#39;json&#39;, &#39;png&#39;])
{&#39;name&#39;: &#39;all_finetune_inpaint_inpaint_generations1_00_000e8dd5ee75dd6668e978e7a4e6fe54.png&#39;, &#39;md5hash&#39;: &#39;000e8dd5ee75dd6668e978e7a4e6fe54&#39;, &#39;label&#39;: &#39;all&#39;, &#39;method&#39;: &#39;finetune_inpaint&#39;, &#39;submethod&#39;: &#39;inpaint&#39;, &#39;generation_num&#39;: &#39;00&#39;, &#39;tag&#39;: &#39;generations1&#39;}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Thomas Buckley.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>