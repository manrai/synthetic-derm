

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Training a Dermatology Image Classifier with Synthetic Data &mdash; synderm 0.1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=a58bc63e"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            synderm
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="train_with_synthetic_images.html">Vignette: Augmenting an image classifier with synthetic images from your data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">synderm</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Training a Dermatology Image Classifier with Synthetic Data</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/train_fitz_classifier2.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Training-a-Dermatology-Image-Classifier-with-Synthetic-Data">
<h1>Training a Dermatology Image Classifier with Synthetic Data<a class="headerlink" href="#Training-a-Dermatology-Image-Classifier-with-Synthetic-Data" title="Link to this heading"></a></h1>
<p>This notebook demonstrates how to train an image classifier for dermatological conditions using both real and synthetic images. We’ll explore how synthetic data can improve model performance, especially in scenarios with limited real training data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO: update this notebook using the new train/test split code and Fitz classifier</span>
</pre></div>
</div>
</div>
<section id="Step-1:-Setup-and-Imports">
<h2>Step 1: Setup and Imports<a class="headerlink" href="#Step-1:-Setup-and-Imports" title="Link to this heading"></a></h2>
<p>First, let’s import all necessary libraries:</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-e</span> <span class="pre">.</span></code> to install the synderm package</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">synderm.splits.train_test_splitter</span> <span class="kn">import</span> <span class="n">synthetic_train_val_split</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.proportion</span> <span class="kn">import</span> <span class="n">proportion_confint</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span><span class="p">,</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">fastai.vision.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">wandb</span>
<span class="kn">from</span> <span class="nn">fastai.callback.wandb</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.proportion</span> <span class="kn">import</span> <span class="n">proportion_confint</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
</section>
<section id="Step-2:-Data-Loading-and-Preparation">
<h2>Step 2: Data Loading and Preparation<a class="headerlink" href="#Step-2:-Data-Loading-and-Preparation" title="Link to this heading"></a></h2>
<p>We’ll use the Fitzpatrick17k dataset, focusing on the top 9 most common skin conditions:</p>
<p>We will: 1. Load training data from Fitzpatrick17k dataset 2. Select the top 9 most frequent skin conditions 3. Set up proper file paths 4. Verify train/test set separation</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set image directory and fastai path</span>
<span class="n">image_dir</span> <span class="o">=</span> <span class="s2">&quot;/n/data1/hms/dbmi/manrai/derm/&quot;</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">image_dir</span><span class="p">)</span>

<span class="c1"># Set the generation folder, this is where images are stored</span>
<span class="n">generation_folder</span> <span class="o">=</span> <span class="s2">&quot;all_generations/finetune-inpaint/&quot;</span>
<span class="n">generation_type</span> <span class="o">=</span> <span class="s2">&quot;inpaint&quot;</span>

<span class="c1"># Load in the training data</span>
<span class="n">metadata_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;/n/data1/hms/dbmi/manrai/derm/Fitzpatrick17k/fitzpatrick17k_10label_clean_training.csv&quot;</span><span class="p">)</span>
<span class="n">top_n_labels</span> <span class="o">=</span> <span class="n">metadata_train</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>
<span class="n">metadata_train</span> <span class="o">=</span> <span class="n">metadata_train</span><span class="p">[</span><span class="n">metadata_train</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_n_labels</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">metadata_train</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Fitzpatrick17k/finalfitz17k/&#39;</span> <span class="o">+</span> <span class="n">metadata_train</span><span class="p">[</span><span class="s1">&#39;md5hash&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span>
<span class="n">metadata_train</span><span class="p">[</span><span class="s2">&quot;synthetic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Load in testing data</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;/n/data1/hms/dbmi/manrai/derm/Fitzpatrick17k/fitzpatrick17k_10label_clean_held_out_set.csv&quot;</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">test_data</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_n_labels</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Fitzpatrick17k/finalfitz17k/&#39;</span> <span class="o">+</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;md5hash&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span>
<span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;synthetic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">ids_train</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metadata_train</span><span class="p">[</span><span class="s2">&quot;md5hash&quot;</span><span class="p">])</span>
<span class="n">ids_test</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s2">&quot;md5hash&quot;</span><span class="p">])</span>

<span class="k">if</span> <span class="n">ids_train</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">ids_test</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train/test mutually exclusive.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train/test not mutually exclusive.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
train/test mutually exclusive.
</pre></div></div>
</div>
</section>
<section id="Step-3:-Experiment-Parameters">
<h2>Step 3: Experiment Parameters<a class="headerlink" href="#Step-3:-Experiment-Parameters" title="Link to this heading"></a></h2>
<p>Define key parameters for our experiment: - <code class="docutils literal notranslate"><span class="pre">per_class_test_size</span></code>: Number of test images per class (40) - <code class="docutils literal notranslate"><span class="pre">n_real_per_class</span></code>: Number of real training images per class (32) - <code class="docutils literal notranslate"><span class="pre">n_synthetic_per_real</span></code>: Number of synthetic images generated per real image (10)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Experiment parameters</span>
<span class="n">per_class_test_size</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">n_real_per_class</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">n_synthetic_per_real</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">random_state</span> <span class="o">=</span> <span class="mi">111108</span>
</pre></div>
</div>
</div>
</section>
<section id="Step-4:-Synthetic-Data-Generation">
<h2>Step 4: Synthetic Data Generation<a class="headerlink" href="#Step-4:-Synthetic-Data-Generation" title="Link to this heading"></a></h2>
<p>Create our synthetic dataset by: 1. Duplicating the real dataset 2. Assigning unique identifiers 3. Defining the paths to the synthetic images</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># First, the dataset is duplicated n_synthetic_per_real times</span>
<span class="n">df_synthetic</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metadata_train</span><span class="p">]</span><span class="o">*</span><span class="n">n_synthetic_per_real</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># create a variable that represents the nth copy of the image</span>
<span class="n">df_synthetic</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_synthetic</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;md5hash&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span>
<span class="n">df_synthetic</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generation_folder</span> <span class="o">+</span> <span class="n">df_synthetic</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">generation_type</span> <span class="o">+</span><span class="s1">&#39;/0&#39;</span> <span class="o">+</span> <span class="n">df_synthetic</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">df_synthetic</span><span class="p">[</span><span class="s1">&#39;md5hash&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
<span class="n">df_synthetic</span><span class="p">[</span><span class="s1">&#39;synthetic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">df_synthetic</span><span class="p">[</span><span class="s1">&#39;Qc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># drop the &#39;n&#39; column</span>
<span class="n">df_synthetic</span> <span class="o">=</span> <span class="n">df_synthetic</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</section>
<section id="Step-5:-Model-Training-with-Synthetic-Data">
<h2>Step 5: Model Training with Synthetic Data<a class="headerlink" href="#Step-5:-Model-Training-with-Synthetic-Data" title="Link to this heading"></a></h2>
<p>Now we’ll train our first model using both real and synthetic images:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">synthetic_train_val_split</span><span class="p">(</span>
    <span class="n">real_data</span> <span class="o">=</span> <span class="n">metadata_train</span><span class="p">,</span>
    <span class="n">synthetic_data</span> <span class="o">=</span> <span class="n">df_synthetic</span><span class="p">,</span>
    <span class="n">per_class_test_size</span> <span class="o">=</span> <span class="n">per_class_test_size</span><span class="p">,</span>
    <span class="n">n_real_per_class</span> <span class="o">=</span> <span class="n">n_real_per_class</span><span class="p">,</span>
    <span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span><span class="p">,</span>
    <span class="n">class_column</span> <span class="o">=</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span>
    <span class="n">mapping_real_to_synthetic</span> <span class="o">=</span> <span class="s2">&quot;md5hash&quot;</span>
    <span class="p">)</span>

<span class="c1"># Add &#39;is_valid&#39; column</span>
<span class="n">train</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">val</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># adjust batch size based on number of images</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_valid</span> <span class="o">==</span> <span class="kc">False</span><span class="p">])</span><span class="o">/</span><span class="mi">10</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">):</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">is_valid</span> <span class="o">==</span> <span class="kc">False</span><span class="p">])</span><span class="o">/</span><span class="mi">10</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
</pre></div>
</div>
</div>
<p>The model uses: - EfficientNetV2-M architecture - Early stopping to prevent overfitting - Dynamic batch sizing based on dataset size</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a fastai dataloader</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">ImageDataLoaders</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                        <span class="n">path</span><span class="p">,</span>
                        <span class="n">fn_col</span><span class="o">=</span><span class="s1">&#39;location&#39;</span><span class="p">,</span>
                        <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span>
                        <span class="n">valid_col</span><span class="o">=</span><span class="s1">&#39;is_valid&#39;</span><span class="p">,</span>
                        <span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                        <span class="n">item_tfms</span><span class="o">=</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                        <span class="n">batch_tfms</span><span class="o">=</span><span class="p">[])</span>

<span class="c1"># Create the learner</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">vision_learner</span><span class="p">(</span>
    <span class="n">dls</span><span class="p">,</span>
    <span class="n">arch</span><span class="o">=</span><span class="n">efficientnet_v2_m</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">error_rate</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Fit without wandb callback</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">EarlyStoppingCallback</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;valid_loss&#39;</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/thb286/synthetic-derm/.venv/lib/python3.10/site-packages/torchvision/models/_utils.py:208: UserWarning: The parameter &#39;pretrained&#39; is deprecated since 0.13 and may be removed in the future, please use &#39;weights&#39; instead.
  warnings.warn(
/home/thb286/synthetic-derm/.venv/lib/python3.10/site-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for &#39;weights&#39; are deprecated since 0.13 and may be removed in the future. The current behavior is equivalent to passing `weights=EfficientNet_V2_M_Weights.IMAGENET1K_V1`. You can also use `weights=EfficientNet_V2_M_Weights.DEFAULT` to get the most up-to-date weights.
  warnings.warn(msg)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.959998</td>
      <td>2.758843</td>
      <td>0.716667</td>
      <td>0.283333</td>
      <td>00:45</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1.182790</td>
      <td>2.900020</td>
      <td>0.705556</td>
      <td>0.294444</td>
      <td>00:57</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.739314</td>
      <td>3.136784</td>
      <td>0.725000</td>
      <td>0.275000</td>
      <td>00:44</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.518641</td>
      <td>3.127845</td>
      <td>0.708333</td>
      <td>0.291667</td>
      <td>00:54</td>
    </tr>
  </tbody>
</table></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
No improvement since epoch 0: early stopping
</pre></div></div>
</div>
</section>
<section id="Step-6:-Model-Evaluation-(with-Synthetic-Data)">
<h2>Step 6: Model Evaluation (with Synthetic Data)<a class="headerlink" href="#Step-6:-Model-Evaluation-(with-Synthetic-Data)" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Predict on test data</span>
<span class="n">test_dl</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">test_dl</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

<span class="c1"># Get predictions and probabilities for test set</span>
<span class="n">preds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">dl</span><span class="o">=</span><span class="n">test_dl</span><span class="p">)</span>

<span class="c1"># Get top-3 probabilities and labels</span>
<span class="n">top3_prob</span><span class="p">,</span> <span class="n">top3_label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Convert top3_label indices to class labels</span>
<span class="n">top3_label</span> <span class="o">=</span> <span class="p">[[</span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span> <span class="k">for</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">top3_label</span><span class="p">]</span>

<span class="c1"># Get true labels for test set</span>
<span class="n">true_labels</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Calculate top-1 accuracy</span>
<span class="n">top1_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">top3_label</span><span class="p">]</span>
<span class="n">top1_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">top1_label</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">true_labels</span><span class="p">))</span>

<span class="c1"># Calculate top-3 accuracy</span>
<span class="n">top3_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span>
    <span class="n">true_labels</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">top3_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">true_labels</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">top1_ci_lower</span><span class="p">,</span> <span class="n">top1_ci_upper</span> <span class="o">=</span> <span class="n">proportion_confint</span><span class="p">(</span>
    <span class="n">count</span><span class="o">=</span><span class="n">top1_acc</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_labels</span><span class="p">),</span>
    <span class="n">nobs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">true_labels</span><span class="p">),</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span>
<span class="p">)</span>
<span class="n">top3_ci_lower</span><span class="p">,</span> <span class="n">top3_ci_upper</span> <span class="o">=</span> <span class="n">proportion_confint</span><span class="p">(</span>
    <span class="n">count</span><span class="o">=</span><span class="n">top3_acc</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_labels</span><span class="p">),</span>
    <span class="n">nobs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">true_labels</span><span class="p">),</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span>
<span class="p">)</span>

<span class="c1"># Print accuracy scores</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy of the model including synthetic images: &quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Top-1 Accuracy: </span><span class="si">{</span><span class="n">top1_acc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Top-1 95% CI: </span><span class="si">{</span><span class="n">top1_ci_lower</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">top1_ci_upper</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Top-3 Accuracy: </span><span class="si">{</span><span class="n">top3_acc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Top-3 95% CI: </span><span class="si">{</span><span class="n">top3_ci_lower</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">top3_ci_upper</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Extract top-1, top-2, and top-3 probabilities</span>
<span class="n">top1_prob_arr</span> <span class="o">=</span> <span class="n">top3_prob</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">top2_prob_arr</span> <span class="o">=</span> <span class="n">top3_prob</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">top3_prob_arr</span> <span class="o">=</span> <span class="n">top3_prob</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="c1"># Extract top-1, top-2, and top-3 labels</span>
<span class="n">top1_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">top3_label</span><span class="p">]</span>
<span class="n">top2_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">top3_label</span><span class="p">]</span>
<span class="n">top3_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">top3_label</span><span class="p">]</span>

<span class="c1"># Get md5hashes</span>
<span class="n">md5hashes</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;md5hash&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Create dataframe of predictions</span>
<span class="n">df_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;architecture&#39;</span><span class="p">:</span> <span class="s2">&quot;EfficientNet-V2-M&quot;</span><span class="p">,</span>
    <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="n">random_state</span><span class="p">,</span>
    <span class="s1">&#39;augmentation&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
    <span class="s1">&#39;gen_folder&#39;</span><span class="p">:</span> <span class="n">generation_folder</span><span class="p">,</span>
    <span class="s1">&#39;generation_type&#39;</span><span class="p">:</span> <span class="n">generation_type</span><span class="p">,</span>
    <span class="s1">&#39;n_training_per_label&#39;</span><span class="p">:</span> <span class="n">n_real_per_class</span><span class="p">,</span>
    <span class="s1">&#39;n_synthetic_per_real&#39;</span><span class="p">:</span> <span class="n">n_synthetic_per_real</span><span class="p">,</span>
    <span class="s1">&#39;include_synthetic&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;md5hash&#39;</span><span class="p">:</span> <span class="n">md5hashes</span><span class="p">,</span>
    <span class="s1">&#39;true_label&#39;</span><span class="p">:</span> <span class="n">true_labels</span><span class="p">,</span>
    <span class="s1">&#39;top1_label&#39;</span><span class="p">:</span> <span class="n">top1_label</span><span class="p">,</span>
    <span class="s1">&#39;top1_prob&#39;</span><span class="p">:</span> <span class="n">top1_prob_arr</span><span class="p">,</span>
    <span class="s1">&#39;top2_label&#39;</span><span class="p">:</span> <span class="n">top2_label</span><span class="p">,</span>
    <span class="s1">&#39;top2_prob&#39;</span><span class="p">:</span> <span class="n">top2_prob_arr</span><span class="p">,</span>
    <span class="s1">&#39;top3_label&#39;</span><span class="p">:</span> <span class="n">top3_label</span><span class="p">,</span>
    <span class="s1">&#39;top3_prob&#39;</span><span class="p">:</span> <span class="n">top3_prob_arr</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<!-- empty output --></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Accuracy of the model including synthetic images:
Top-1 Accuracy: 0.24166666666666667
Top-1 95% CI: 0.19744498136010485 - 0.2858883519732285
Top-3 Accuracy: 0.5277777777777778
Top-3 95% CI: 0.47620795950042477 - 0.5793475960551309
</pre></div></div>
</div>
</section>
<section id="Step-7:-Baseline-Model-(No-Synthetic-Data)">
<h2>Step 7: Baseline Model (No Synthetic Data)<a class="headerlink" href="#Step-7:-Baseline-Model-(No-Synthetic-Data)" title="Link to this heading"></a></h2>
<p>For comparison, we’ll train and evaluate a model using only the real images:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_ns</span><span class="p">,</span> <span class="n">val_ns</span> <span class="o">=</span> <span class="n">synthetic_train_val_split</span><span class="p">(</span>
    <span class="n">real_data</span> <span class="o">=</span> <span class="n">metadata_train</span><span class="p">,</span>
    <span class="n">synthetic_data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">per_class_test_size</span> <span class="o">=</span> <span class="n">per_class_test_size</span><span class="p">,</span>
    <span class="n">n_real_per_class</span> <span class="o">=</span> <span class="n">n_real_per_class</span><span class="p">,</span>
    <span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span><span class="p">,</span>
    <span class="n">class_column</span> <span class="o">=</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span>
    <span class="n">mapping_real_to_synthetic</span> <span class="o">=</span> <span class="s2">&quot;md5hash&quot;</span>
    <span class="p">)</span>

<span class="c1"># Add &#39;is_valid&#39; column</span>
<span class="n">train_ns</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">val_ns</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">df_ns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_ns</span><span class="p">,</span> <span class="n">val_ns</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># adjust batch size based on number of images</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_ns</span><span class="p">[</span><span class="n">df_ns</span><span class="o">.</span><span class="n">is_valid</span> <span class="o">==</span> <span class="kc">False</span><span class="p">])</span><span class="o">/</span><span class="mi">10</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">):</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_ns</span><span class="p">[</span><span class="n">df_ns</span><span class="o">.</span><span class="n">is_valid</span> <span class="o">==</span> <span class="kc">False</span><span class="p">])</span><span class="o">/</span><span class="mi">10</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a fastai dataloader</span>
<span class="n">dls_ns</span> <span class="o">=</span> <span class="n">ImageDataLoaders</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">df_ns</span><span class="p">,</span>
                        <span class="n">path</span><span class="p">,</span>
                        <span class="n">fn_col</span><span class="o">=</span><span class="s1">&#39;location&#39;</span><span class="p">,</span>
                        <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span>
                        <span class="n">valid_col</span><span class="o">=</span><span class="s1">&#39;is_valid&#39;</span><span class="p">,</span>
                        <span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                        <span class="n">item_tfms</span><span class="o">=</span><span class="n">Resize</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                        <span class="n">batch_tfms</span><span class="o">=</span><span class="p">[])</span>

<span class="c1"># Create the learner</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">vision_learner</span><span class="p">(</span>
    <span class="n">dls_ns</span><span class="p">,</span>
    <span class="n">arch</span><span class="o">=</span><span class="n">efficientnet_v2_m</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">error_rate</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Fit without wandb callback</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">EarlyStoppingCallback</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;valid_loss&#39;</span><span class="p">,</span> <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/thb286/synthetic-derm/.venv/lib/python3.10/site-packages/torchvision/models/_utils.py:208: UserWarning: The parameter &#39;pretrained&#39; is deprecated since 0.13 and may be removed in the future, please use &#39;weights&#39; instead.
  warnings.warn(
/home/thb286/synthetic-derm/.venv/lib/python3.10/site-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for &#39;weights&#39; are deprecated since 0.13 and may be removed in the future. The current behavior is equivalent to passing `weights=EfficientNet_V2_M_Weights.IMAGENET1K_V1`. You can also use `weights=EfficientNet_V2_M_Weights.DEFAULT` to get the most up-to-date weights.
  warnings.warn(msg)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>3.826281</td>
      <td>2.661138</td>
      <td>0.827778</td>
      <td>0.172222</td>
      <td>00:05</td>
    </tr>
    <tr>
      <td>1</td>
      <td>3.263444</td>
      <td>2.559533</td>
      <td>0.816667</td>
      <td>0.183333</td>
      <td>00:05</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2.932132</td>
      <td>2.562016</td>
      <td>0.825000</td>
      <td>0.175000</td>
      <td>00:05</td>
    </tr>
    <tr>
      <td>3</td>
      <td>2.645862</td>
      <td>2.635431</td>
      <td>0.797222</td>
      <td>0.202778</td>
      <td>00:05</td>
    </tr>
    <tr>
      <td>4</td>
      <td>2.453256</td>
      <td>2.700307</td>
      <td>0.777778</td>
      <td>0.222222</td>
      <td>00:04</td>
    </tr>
  </tbody>
</table></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
No improvement since epoch 1: early stopping
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Predict on test data</span>
<span class="n">test_dl</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">test_dl</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

<span class="c1"># Get predictions and probabilities for test set</span>
<span class="n">preds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">dl</span><span class="o">=</span><span class="n">test_dl</span><span class="p">)</span>

<span class="c1"># Get top-3 probabilities and labels</span>
<span class="n">top3_prob</span><span class="p">,</span> <span class="n">top3_label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Convert top3_label indices to class labels</span>
<span class="n">top3_label</span> <span class="o">=</span> <span class="p">[[</span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span> <span class="k">for</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">top3_label</span><span class="p">]</span>

<span class="c1"># Get true labels for test set</span>
<span class="n">true_labels</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Calculate top-1 accuracy</span>
<span class="n">top1_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">top3_label</span><span class="p">]</span>
<span class="n">top1_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">top1_label</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">true_labels</span><span class="p">))</span>

<span class="c1"># Calculate top-3 accuracy</span>
<span class="n">top3_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span>
    <span class="n">true_labels</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">top3_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">true_labels</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">top1_ci_lower</span><span class="p">,</span> <span class="n">top1_ci_upper</span> <span class="o">=</span> <span class="n">proportion_confint</span><span class="p">(</span>
    <span class="n">count</span><span class="o">=</span><span class="n">top1_acc</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_labels</span><span class="p">),</span>
    <span class="n">nobs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">true_labels</span><span class="p">),</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span>
<span class="p">)</span>
<span class="n">top3_ci_lower</span><span class="p">,</span> <span class="n">top3_ci_upper</span> <span class="o">=</span> <span class="n">proportion_confint</span><span class="p">(</span>
    <span class="n">count</span><span class="o">=</span><span class="n">top3_acc</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_labels</span><span class="p">),</span>
    <span class="n">nobs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">true_labels</span><span class="p">),</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span>
<span class="p">)</span>

<span class="c1"># Print accuracy scores</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy of the model (no synthetic images): &quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Top-1 Accuracy: </span><span class="si">{</span><span class="n">top1_acc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Top-1 95% CI: </span><span class="si">{</span><span class="n">top1_ci_lower</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">top1_ci_upper</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Top-3 Accuracy: </span><span class="si">{</span><span class="n">top3_acc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Top-3 95% CI: </span><span class="si">{</span><span class="n">top3_ci_lower</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">top3_ci_upper</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Extract top-1, top-2, and top-3 probabilities</span>
<span class="n">top1_prob_arr</span> <span class="o">=</span> <span class="n">top3_prob</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">top2_prob_arr</span> <span class="o">=</span> <span class="n">top3_prob</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">top3_prob_arr</span> <span class="o">=</span> <span class="n">top3_prob</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="c1"># Extract top-1, top-2, and top-3 labels</span>
<span class="n">top1_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">top3_label</span><span class="p">]</span>
<span class="n">top2_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">top3_label</span><span class="p">]</span>
<span class="n">top3_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">top3_label</span><span class="p">]</span>

<span class="c1"># Get md5hashes</span>
<span class="n">md5hashes</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;md5hash&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Create dataframe of predictions</span>
<span class="n">df_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;architecture&#39;</span><span class="p">:</span> <span class="s2">&quot;EfficientNet-V2-M&quot;</span><span class="p">,</span>
    <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="n">random_state</span><span class="p">,</span>
    <span class="s1">&#39;augmentation&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
    <span class="s1">&#39;gen_folder&#39;</span><span class="p">:</span> <span class="n">generation_folder</span><span class="p">,</span>
    <span class="s1">&#39;generation_type&#39;</span><span class="p">:</span> <span class="n">generation_type</span><span class="p">,</span>
    <span class="s1">&#39;n_training_per_label&#39;</span><span class="p">:</span> <span class="n">n_real_per_class</span><span class="p">,</span>
    <span class="s1">&#39;n_synthetic_per_real&#39;</span><span class="p">:</span> <span class="n">n_synthetic_per_real</span><span class="p">,</span>
    <span class="s1">&#39;include_synthetic&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;md5hash&#39;</span><span class="p">:</span> <span class="n">md5hashes</span><span class="p">,</span>
    <span class="s1">&#39;true_label&#39;</span><span class="p">:</span> <span class="n">true_labels</span><span class="p">,</span>
    <span class="s1">&#39;top1_label&#39;</span><span class="p">:</span> <span class="n">top1_label</span><span class="p">,</span>
    <span class="s1">&#39;top1_prob&#39;</span><span class="p">:</span> <span class="n">top1_prob_arr</span><span class="p">,</span>
    <span class="s1">&#39;top2_label&#39;</span><span class="p">:</span> <span class="n">top2_label</span><span class="p">,</span>
    <span class="s1">&#39;top2_prob&#39;</span><span class="p">:</span> <span class="n">top2_prob_arr</span><span class="p">,</span>
    <span class="s1">&#39;top3_label&#39;</span><span class="p">:</span> <span class="n">top3_label</span><span class="p">,</span>
    <span class="s1">&#39;top3_prob&#39;</span><span class="p">:</span> <span class="n">top3_prob_arr</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
  <progress value='0' class='' max='6' style='width:300px; height:20px; vertical-align: middle;'></progress>
  0.00% [0/6 00:00&lt;?]
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Accuracy of the model (no synthetic images):
Top-1 Accuracy: 0.18888888888888888
Top-1 95% CI: 0.14845549263775715 - 0.22932228514002062
Top-3 Accuracy: 0.49166666666666664
Top-3 95% CI: 0.4400242546931338 - 0.5433090786401995
</pre></div></div>
</div>
</section>
<section id="Run-the-complete-experiment">
<h2>Run the complete experiment<a class="headerlink" href="#Run-the-complete-experiment" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The entire experiment can be run using this script, although this will take a while to run</span>
<span class="o">!</span>python<span class="w"> </span>skin_classification_with_augmentation.py<span class="w"> </span><span class="err">\</span>
    <span class="o">--</span><span class="n">dataset</span> <span class="n">hugginface_repo</span> \
    <span class="o">--</span><span class="n">n_real_per_label_list</span> <span class="s2">&quot;[1, 8, 16, 32, 64, 128, 228]&quot;</span> \
    <span class="o">--</span><span class="n">max_batch_size</span> <span class="mi">32</span> \
    <span class="o">--</span><span class="n">arg2</span> <span class="n">value2</span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Thomas Buckley.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>